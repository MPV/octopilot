<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.84.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Octopilot - Octopilot</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=favicon.png><link rel=stylesheet href=css/style.893557bc36f9dfda17c26bcf9db87c3f52ed314bc1fc66448453774f79f6ab02.css></head><body class="page page-default-single"><div class=wrapper><div class=header><div class=container><div class=logo><a href=/>Octopilot</a></div><div id=main-menu class=main-menu><ul><li class=menu-item-><a href=https://github.com/dailymotion-oss/octopilot><span>GitHub</span></a></li><li class=menu-item-><a href=https://github.com/dailymotion-oss><span>Dailymotion</span></a></li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box><span class=hamburger-inner></span></span></button></div></div><div class="container pt-2 pt-md-6 pb-3 pb-md-6"><div class=row><div class="col-12 col-md-3 mb-3"><div class=sidebar><div class=docs-menu><div class=navigation><nav class=internal><ul><li><a href=#intro>Introduction</a></li><li><a href=#usage>Usage</a></li><li><a href=#repos>Repositories</a><ul><li><a href=#static>Static list</a></li><li><a href=#dynamic>Dynamic list</a></li><li><a href=#commit>Commits</a></li><li><a href=#pull-request>Pull Requests</a></li></ul></li><li><a href=#updaters>Updaters</a><ul><li><a href=#yaml>YAML</a></li><li><a href=#yq>YQ</a></li><li><a href=#helm>Helm</a></li><li><a href=#sops>Sops</a></li><li><a href=#regex>Regex</a></li><li><a href=#exec>Exec</a></li><li><a href=#value>Value</a></li></ul></li><li><a href=#github>GitHub</a><ul><li><a href=#auth>Auth</a></li></ul></li><li><a href=#advanced>Advanced</a><ul><li><a href=#templating>Templating</a></li></ul></li><li><a href=#use-cases>Use cases</a></li><li><a href=#faq>FAQ</a></li></ul></nav><nav class=external><div class=external-title></div><ul id=shortcuts><li><a href=https://github.com/dailymotion-oss/octopilot target=_blank rel=noopener>Source Code</a></li></ul></nav></div><div class=version>v0.2.19 released on Jul 13, 2021</div></div></div></div><div class="col-12 col-md-9"><h1 class=title>Documentation for Octopilot v0.2.19</h1><h2>Released on Jul 13, 2021</h2><div class=content><section class=changelog><div class=content><p>This is the full 1-page documentation for <a href=https://github.com/dailymotion-oss/octopilot/releases/tag/v0.2.19>Octopilot v0.2.19</a>.</p><h2 id=changelog>Changelog</h2><h3 id=documentation>Documentation</h3><ul><li>add commit/pr doc (<a href=https://github.com/dailymotion-oss/octopilot/issues/70>#70</a>)</li></ul></div></section><section id=intro><h1><a href=#intro>Introduction</a></h1><div class=content><p><strong>Octopilot</strong> is a CLI tool designed to help you automate your Gitops workflow, by automatically creating and merging GitHub Pull Requests to update specific content in Git repositories.</p><p>It works by:</p><ul><li>cloning one or more <a href=#repos>repositories</a>, defined either:<ul><li><a href=#static>statically</a></li><li><a href=#dynamic>dynamically</a>, using environment variables or GitHub search queries</li></ul></li><li>running one or more <a href=#updaters>updaters</a> on each cloned repository, using either:<ul><li>the <a href=#yaml>YAML updater</a>, to quickly update YAML files</li><li>the <a href=#yq>YQ updater</a>, based on <a href=https://github.com/mikefarah/yq>mikefarah&rsquo;s yq</a>, to manipulate YAML or JSON files as you want</li><li>the <a href=#helm>Helm updater</a>, to easily update the dependencies of an <a href=https://helm.sh/>Helm</a> chart</li><li>The <a href=#sops>sops updater</a>, to manipulate files encrypted with <a href=https://github.com/mozilla/sops>mozilla&rsquo;s sops</a></li><li>The <a href=#regex>regex updater</a>, to update any kind of text file using a regular expression</li><li>The <a href=#exec>exec updater</a>, to execute any command you want</li></ul></li><li><a href=#commit>commit/push</a> the changes</li><li>create <a href=#pull-request>Pull Requests</a> and optionally merge them</li></ul></div></section><section id=usage><h1><a href=#usage>Usage</a></h1><div class=content><p>You can download the binary or see the <code>docker pull</code> commands from the <a href=https://github.com/dailymotion-oss/octopilot/releases/latest>release page on GitHub</a>.</p><p>There are no dependencies - not even on <code>git</code>.</p><p>There are no configuration files - we use CLI flags for everything. You can run <code>octopilot -h</code> to see all the flags. Some of them can be use multiple times, such as the <code>--repo</code> or <code>--update</code> flags.</p><p>Here is an example of using Octopilot to update multiple repositories, using multiple updaters:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --repo &#34;my-org/some-repo&#34; \
    --repo &#34;my-org/another-repo(merge=true)&#34; \
    --repo &#34;discover-from(env=PROMOTE_TO_REPOSITORIES)&#34; \
    --repo &#34;discover-from(query=org:my-org topic:my-topic)&#34; \
    --update &#34;yaml(file=config.yaml,path=&#39;version&#39;)=file(path=VERSION)&#34; \
    --update `yq(file=helmfile.yaml,expression=&#39;(.releases[] | select(.chart == &#34;repo/my-chart&#34;) | .version ) = strenv(VERSION)&#39;)` \
    --update `sops(file=secrets.yaml,key=path.to.base64encodedCertificateKey)=$(kubectl -n cert-manager get secrets tls-myapp -o template=&#39;{{index .data &#34;tls.key&#34;}}&#39;)` \
    --pr-title &#34;Updating some files&#34; \
    ...
</code></pre></div></div></section><section id=repos><h1><a href=#repos>Repositories</a></h1><div class=content><p>Octopilot operates on GitHub repositories. A single execution of Octopilot can update one or more repositories. There are 2 ways to define the repositories to update:</p><ul><li>using a <a href=#static>static list</a></li><li>using a <a href=#dynamic>dynamic list</a></li></ul></div></section><section id=static><h1><a href=#static>Static list</a></h1><div class=content><p>It is the easiest: just specify the repositories on the CLI using the <code>--repo</code> flag, such as:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --repo &#34;my-github-org/my-first-repo&#34; \
    --repo &#34;my-github-org/my-second-repo(merge=true)&#34; \
    --repo &#34;my-github-org/my-third-repo(draft=true,merge=false)&#34;
</code></pre></div><p>You can add as much repositories as you want, each with different configuration.</p><p>It support the following parameters:</p><ul><li><code>merge</code> (boolean): if <code>true</code>, then the PR created on this repository will be automatically merged - see the <a href=#pull-request>Pull Requests</a> section for more details. It overrides the value of the <code>--pr-merge</code> flag for this specific repository.</li><li><code>draft</code> (boolean): if <code>true</code>, then the PR will be created as a <a href=https://github.blog/2019-02-14-introducing-draft-pull-requests/>draft PR</a> on GitHub. You will need to manually mark it as &ldquo;ready for review&rdquo; before being able to merge it. It overrides the value of the <code>--pr-draft</code> flag for this specific repository.</li><li><code>branch</code> (string): the name of the base branch to use when cloning the repository. Default to the <code>HEAD</code> branch - which means the default branch configured in GitHub: usually <code>main</code> or <code>master</code>.</li></ul></div></section><section id=dynamic><h1><a href=#dynamic>Dynamic list</a></h1><div class=content><p>Octopilot can also be used with a &ldquo;dynamic&rdquo; list of repositories: repositories which are unknown when you write the command arguments.</p><p>It can retrieve the list of repositories to update from:</p><ul><li>one or more <strong>environment variables</strong></li><li>one or more <a href=https://docs.github.com/en/github/searching-for-information-on-github/searching-on-github/searching-for-repositories>GitHub Search Query</a></li></ul><h2 id=using-environment-variables>Using environment variables</h2><p>At runtime, Octopilot will read the list of repositories defined in one or more environment variables, such as:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ export PROMOTE_TO_REPOSITORIES=&#34;my-github-org/my-first-repo my-github-org/my-second-repo(draft=true,merge=false)&#34;
$ export ANOTHER_SET_OF_REPOSITORIES=&#34;some-org/some-repo;another-org/another-repo(draft=false)&#34;
$ octopilot \
    --repo &#34;discover-from(env=PROMOTE_TO_REPOSITORIES)&#34; \
    --repo &#34;discover-from(env=ANOTHER_SET_OF_REPOSITORIES,sep=;,draft=true)&#34;
</code></pre></div><p>It support the following parameters:</p><ul><li><code>env</code> (string): the name of the environment variable to use, to retrieve the list of repositories.</li><li><code>sep</code> (string): the separator between each repository, default to <code>" "</code> (space).</li><li><code>merge</code> (boolean): if <code>true</code>, then the PRs created on the repositories from this env var will be automatically merged - see the <a href=#pull-request>Pull Requests</a> section for more details. It overrides the value of the <code>--pr-merge</code> flag for the repositories defined in this env var.</li><li><code>draft</code> (boolean): if <code>true</code>, then the PRs will be created as <a href=https://github.blog/2019-02-14-introducing-draft-pull-requests/>draft PRs</a> on GitHub. You will need to manually mark them as &ldquo;ready for review&rdquo; before being able to merge them. It overrides the value of the <code>--pr-draft</code> flag for the repositories defined in this env var.</li><li><code>branch</code> (string): the name of the base branch to use when cloning the repositories. Default to the <code>HEAD</code> branch - which means the default branch configured in GitHub: usually <code>main</code> or <code>master</code>.</li></ul><p>Note that each repository listed in an environment variable supports all the parameters defined in the <a href=#static>static definition of a repository</a>.</p><h2 id=using-github-search-query>Using GitHub Search Query</h2><p>A more powerful feature is the ability to load a list of repositories from a <a href=https://docs.github.com/en/github/searching-for-information-on-github/searching-on-github/searching-for-repositories>GitHub Search Query</a>, such as:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --repo &#34;discover-from(query=org:my-github-org topic:some-topic)&#34;
</code></pre></div><p>At runtime, Octopilot will use the GitHub API to retrieve the list of repositories matching a given query. This is useful when you have a common library used/imported by many repositories, and you want to create a PR to update the version when there is a new release of your lib. Instead of hardcoding the list of &ldquo;dependant&rdquo; repositories in your library repository, you can use a GitHub Search Query to find all repositories with a specific topic, or a specific content in the description of the repo, or a specific content in the README.md file of the repo, and so on. So &ldquo;dependant&rdquo; repositories can easily opt-in to get automatic PRs just by adding a topic for example.</p><p>It support the following parameters:</p><ul><li><code>query</code> (string): the name of the environment variable to use, to retrieve the list of repositories.</li><li><code>merge</code> (boolean): if <code>true</code>, then the PRs created on the repositories from this query will be automatically merged - see the <a href=#pull-request>Pull Requests</a> section for more details. It overrides the value of the <code>--pr-merge</code> flag for the repositories retrieved from this query.</li><li><code>draft</code> (boolean): if <code>true</code>, then the PRs will be created as <a href=https://github.blog/2019-02-14-introducing-draft-pull-requests/>draft PRs</a> on GitHub. You will need to manually mark them as &ldquo;ready for review&rdquo; before being able to merge them. It overrides the value of the <code>--pr-draft</code> flag for the repositories retrieved from this query.</li><li><code>branch</code> (string): the name of the base branch to use when cloning the repositories. Default to the <code>HEAD</code> branch - which means the default branch configured in GitHub: usually <code>main</code> or <code>master</code>.</li></ul></div></section><section id=commit><h1><a href=#commit>Commits</a></h1><div class=content><p>After running all the <a href=#updaters>updaters</a>, octopilot will commit the changes on each <a href=#repos>repository</a>. You can control which files will be committed, and how the commit will be created, using the Octopilot&rsquo;s CLI flags.</p><h2 id=git-clone>Git clone</h2><p>Flags related to the <code>git clone</code> operation:</p><ul><li><code>--git-clone-dir</code> (string): optional path to a directory used to clone the git repositories. Default to a newly created directory in the system temporary directory (defined by the <code>TMPDIR</code> environment variable, defaulting to <code>/tmp</code>). Note that by default all files created inside this directory will be deleted at the end of the process, unless the <code>--keep-files</code> flag is set.</li></ul><h2 id=git-indexstage>Git index/stage</h2><p>By default, all files changed by the <a href=#updaters>updaters</a> will be added to the git &ldquo;index&rdquo; - so that they can be added to the git commit. This is configurable through the following flags:</p><ul><li><code>--git-stage-all-changed</code> (boolean): if set to <code>true</code> (the default), then all changed files will be &ldquo;staged&rdquo; - or added to the git index. Set it to <code>false</code> to control which files should be staged.</li><li><code>--git-stage-pattern</code> (array of string): list of path patterns that will be &ldquo;staged&rdquo; - or added to the git index.</li></ul><p>For example, to make sure you will only commit the changes to the <code>helmfile.yaml</code> file:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --git-stage-all-changed=false \
    --git-stage-pattern=helmfile.yaml \
    ...
</code></pre></div><h2 id=git-commit>Git commit</h2><p>Although there are good default values, you can configure how Octopilot will create the git commit:</p><ul><li><code>git-author-name</code> (string): the name of the author of the git commit. Default to the value of the <code>GIT_AUTHOR_NAME</code> environment variable, or if unset, the <code>user.name</code> git config value.</li><li><code>git-author-email</code> (string): the email of the author of the git commit. Default to the value of the <code>GIT_AUTHOR_EMAIL</code> environment variable, or if unset, the <code>user.email</code> git config value.</li><li><code>git-committer-name</code> (string): the name of the committer. Default to the value of the <code>GIT_COMMITTER_NAME</code> environment variable, or if unset, the <code>user.name</code> git config value.</li><li><code>git-committer-email</code> (string): the email of the committer. Default to the value of the <code>GIT_COMMITTER_EMAIL</code> environment variable, or if unset, the <code>user.email</code> git config value.</li><li><code>git-commit-title</code> (string): the title of the commit. Note that you can use the <a href=#templating>templating</a> feature here.</li><li><code>git-commit-body</code> (string): the body of the commit. Note that you can use the <a href=#templating>templating</a> feature here.</li><li><code>git-commit-footer</code> (string): the footer of the commit. Default to Octopilot&rsquo;s signature, to indicate that this commit was generated by a tool.</li></ul><p>The commit message is composed of the commit title, body and optional footer:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>${git-commit-title}

${git-commit-body}

-- 
${git-commit-footer}
</code></pre></div><p>For example, to update the version of an application named <code>my-app</code>, and write a nice commit message:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --repo &#34;my-org/my-gitops-repo&#34; \
    --update &#34;yaml(file=my-app/config.yaml,path=&#39;version&#39;)=${VERSION}&#34; \
    --git-commit-title &#39;chore(deps): update my-app to {{ env &#34;VERSION&#34; }}&#39; \
    --git-commit-body &#39;{{ githubRelease (print &#34;my-org/my-app-repo/&#34; (env &#34;VERSION&#34;)) | md2txt }}&#39; \
    ...
</code></pre></div><p>It&rsquo;s using the <a href=#templating>templating</a> feature to retrieve the GitHub Release for your application&rsquo;s version, and convert it to raw text. So in your commit message, you&rsquo;ll see what changed in the new version.</p><h2 id=git-push>Git push</h2><ul><li><code>git-branch-prefix</code> (string): when pushing the changes to the &ldquo;origin&rdquo; git repository, a new branch with a random name will be created. You can control the prefix of this random name, which default to <code>octopilot-</code>.</li></ul></div></section><section id=pull-request><h1><a href=#pull-request>Pull Requests</a></h1><div class=content><p>After running all the <a href=#updaters>updaters</a> and creating a <a href=#commit>git commit</a>, octopilot will create a Pull Request for each <a href=#repos>repository</a>.</p><h2 id=strategies>Strategies</h2><p>Octopilot has 3 strategies for creating a Pull Request:</p><ul><li><strong>reset</strong> (the default): reset any existing Pull Request from the base branch</li><li><strong>append</strong>: append new commits to any existing Pull Request</li><li><strong>recreate</strong>: always create a new Pull Request</li></ul><p>You can control which strategy to use using the <code>--strategy</code> CLI flag.</p><h3 id=reset-strategy>Reset Strategy</h3><p>This is the default strategy. With this strategy, Octopilot will reset any existing Pull Request from the base branch.</p><p>In details, it will:</p><ul><li>clone the git repository</li><li>find a &ldquo;matching&rdquo; Pull Request - based on the pre-configured labels. If there is a matching Pull Request, it will use the PR&rsquo;s branch. Otherwise it will just create a new branch</li><li>reset the branch to the base branch - usually <code>main</code> or <code>master</code></li><li>run the <a href=#updaters>updaters</a></li><li><a href=#commit>commit</a> the changes and (force) push the commit</li><li>update the existing Pull Request title/body/labels/comments or create a new one</li></ul><p>Note that you can control how the existing Pull Request will be updated. For both the title and body, you can either:</p><ul><li><strong>ignore</strong> the new changes. The existing PR won&rsquo;t be changed - except for the labels and comments, and of course the commit.</li><li><strong>replace</strong> the title and/or body with the new ones. This is the default for the <strong>reset</strong> strategy.</li><li><strong>prepend</strong> the title and/or body with the new ones. This is mostly useful for the body.</li><li><strong>append</strong> the title and/or body with the new ones. This is mostly useful for the body.</li></ul><h3 id=append-strategy>Append Strategy</h3><p>With this strategy, Octopilot will append new commits to any existing Pull Request.</p><p>In details, it will:</p><ul><li>clone the git repository</li><li>find a &ldquo;matching&rdquo; Pull Request - based on the pre-configured labels. If there is a matching Pull Request, it will switch to the PR&rsquo;s branch. Otherwise it will just create a new branch from the base branch, and switch to it.</li><li>run the <a href=#updaters>updaters</a></li><li><a href=#commit>commit</a> the changes and push the commit</li><li>update the existing Pull Request title/body/labels/comments or create a new one</li></ul><p>Note that you can control how the existing Pull Request will be updated. For both the title and body, you can either:</p><ul><li><strong>ignore</strong> the new changes. The existing PR won&rsquo;t be changed - except for the labels and comments, and of course the commit. This is the default for the <strong>append</strong> strategy.</li><li><strong>replace</strong> the title and/or body with the new ones.</li><li><strong>prepend</strong> the title and/or body with the new ones. This is mostly useful for the body.</li><li><strong>append</strong> the title and/or body with the new ones. This is mostly useful for the body.</li></ul><h3 id=recreate-strategy>Recreate Strategy</h3><p>With this strategy, Octopilot will always create a new Pull Request.</p><p>In details, it will:</p><ul><li>clone the git repository</li><li>create a new branch from the base branch, and switch to it</li><li>run the <a href=#updaters>updaters</a></li><li><a href=#commit>commit</a> the changes and push the commit</li><li>create a new Pull Request</li></ul><h2 id=creating--updating-pull-requests>Creating / updating Pull Requests</h2><p>You can control how the Pull Requests will be created or updated using the following CLI flags:</p><ul><li><code>--strategy</code> (string): strategy to use when creating/updating the Pull Requests: either <code>reset</code> (reset any existing PR from the current base branch), <code>append</code> (append new commit to any existing PR) or <code>recreate</code> (always create a new PR). Default to <code>reset</code>.</li><li><code>--dry-run</code> (bool): if enabled, won&rsquo;t perform any operation on the remote git repository or on GitHub: all operations will be done in the local cloned repository. So no Pull Request will be created/updated. Default to <code>false</code>.</li><li><code>--pr-title</code> (string): the title of the Pull Request. Default to the commit title. Note that you can use the <a href=#templating>templating</a> feature here.</li><li><code>--pr-title-update-operation</code> (string): the type of operation when updating a Pull Request&rsquo;s title: either <code>ignore</code> (keep old value), <code>replace</code>, <code>prepend</code> or <code>append</code>. Default is: <code>ignore</code> for &ldquo;append&rdquo; strategy, <code>replace</code> for &ldquo;reset&rdquo; strategy, and not applicable for &ldquo;recreate&rdquo; strategy.</li><li><code>--pr-body</code> (string): the body of the Pull Request. Default to the commit body and the commit footer. Note that you can use the <a href=#templating>templating</a> feature here.</li><li><code>--pr-body-update-operation</code> (string): the type of operation when updating a Pull Request&rsquo;s body: either <code>ignore</code> (keep old value), <code>replace</code>, <code>prepend</code> or <code>append</code>. Default is: <code>ignore</code> for &ldquo;append&rdquo; strategy, <code>replace</code> for &ldquo;reset&rdquo; strategy, and not applicable for &ldquo;recreate&rdquo; strategy.</li><li><code>--pr-comment</code> (array of string): optional list of comments to add to the Pull Request.</li><li><code>--pr-labels</code> (array of string): optional list of labels to set on the pull requests, and used to find existing pull requests to update. Default to <code>["octopilot-update"]</code>.</li><li><code>--pr-base-branch</code> (string): name of the branch used as a base when creating pull requests. Default to <code>master</code>.</li><li><code>--pr-draft</code> (bool): if enabled, the Pull Request will be created as a draft - instead of regular ones. It means that the PRs can&rsquo;t be merged until marked as &ldquo;ready for review&rdquo;. Default to <code>false</code>.</li></ul><h2 id=merging-pull-requests>Merging Pull Requests</h2><p>Optionally, Octopilot can also automatically merge the Pull Requests it creates. Before merging a Pull Request, Octopilot will wait for the PR to be in a &ldquo;mergable&rdquo; state, and for all required status checks to pass.</p><ul><li><code>--pr-merge</code> (bool): if enabled, the Pull Requests will be automatically merged. It will wait until the PRs are &ldquo;mergeable&rdquo; before merging them. Default to <code>false</code>.</li></ul><p>All the following flags only apply if <code>--pr-merge</code> is enabled.</p><ul><li><code>--pr-merge-method</code> (string): the merge method to use. Either <code>merge</code>, <code>squash</code>, or <code>rebase</code>. Default to <code>merge</code>.</li><li><code>--pr-merge-commit-title</code> (string): optional title of the merge commit.</li><li><code>--pr-merge-commit-message</code> (string): optional body of the merge commit.</li><li><code>--pr-merge-sha</code> (string): optional SHA that pull request head must match to allow merge.</li><li><code>--pr-merge-poll-timeout</code> (string/duration): maximum duration to wait for a Pull Request to be mergeable, using the <a href=https://golang.org/pkg/time/#ParseDuration>Golang syntax</a>. Default to <code>10m</code> (10 minutes).</li><li><code>--pr-merge-poll-interval</code> (string/duration): duration to wait for between each GitHub API call to check if a PR is mergeable, using the <a href=https://golang.org/pkg/time/#ParseDuration>Golang syntax</a>. Default to <code>30s</code> (30 seconds).</li><li><code>--pr-merge-retry-count</code> (int): number of times to retry the merge operation in case of merge failure. Default to <code>3</code>.</li></ul></div></section><section id=updaters><h1><a href=#updaters>Updaters</a></h1><div class=content><p>The core feature of Octopilot is to update git repositories, and to do it you can use one or more of the available &ldquo;updaters&rdquo;:</p><ul><li>the <a href=#yaml>YAML updater</a>, to quickly update YAML files</li><li>the <a href=#yq>YQ updater</a>, based on <a href=https://github.com/mikefarah/yq>mikefarah&rsquo;s yq</a>, to manipulate YAML or JSON files as you want</li><li>the <a href=#helm>Helm updater</a>, to easily update the dependencies of an <a href=https://helm.sh/>Helm</a> chart</li><li>The <a href=#sops>sops updater</a>, to manipulate files encrypted with <a href=https://github.com/mozilla/sops>mozilla&rsquo;s sops</a></li><li>The <a href=#regex>regex updater</a>, to update any kind of text file using a regular expression</li><li>The <a href=#exec>exec updater</a>, to execute any command you want</li></ul><p>Each updater can be used once or more, such as:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;yaml(file=config.yaml,path=&#39;version&#39;)=file(path=VERSION)&#34; \
    --update &#34;regex(file=some-file.txt,pattern=&#39;version: \&#34;(.*)\&#34;&#39;)=${VERSION}&#34; \
    --update &#34;yaml(file=another-config.yaml,path=&#39;path.to.version&#39;)=$(cat VERSION)&#34; \
    ...
</code></pre></div></div></section><section id=yaml><h1><a href=#yaml>YAML</a></h1><div class=content><p>The YAML updater is great when you want to quickly set a value for a specific path in one or more files. Such as if you want to update a version used in a YAML file:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;yaml(file=config.yaml,path=&#39;app.version&#39;)=file(path=VERSION)&#34; \
    ...
</code></pre></div><p>Given the following <code>config.yaml</code> file:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>app:
  name: foo
  version: 1.0.0
</code></pre></div><p>Octopilot will set the value of the <code>app.version</code> key to the content of the <code>VERSION</code> file.</p><p>The syntax is: <code>yaml(params)=value</code> - you can read more about the value in the <a href=#value>&ldquo;value&rdquo; section</a>.</p><p>It support the following parameters:</p><ul><li><code>file</code> (string): mandatory path to the YAML file to update. Can be a file pattern - such as <code>config/*.yaml</code>. If it&rsquo;s a relative path, it will be relative to the root of the cloned git repository.</li><li><code>path</code> (string): mandatory path to the key to update in the YAML file(s). We support <a href=https://mikefarah.gitbook.io/yq/v/v3.x/usage/path-expressions>yq v3 path expressions</a> or <a href=https://mikefarah.gitbook.io/yq/operators/traverse-read>yq v4 syntax</a>.</li><li><code>indent</code> (int): optional number of spaces used for indentation when writing the YAML file(s) after update. Default to <code>2</code>.</li><li><code>trim</code> (boolean): if <code>true</code>, the content will be &ldquo;trimmed&rdquo; before being written to disk - to avoid extra line break at the end of the file for example.</li><li><code>create</code> (boolean): if <code>true</code>, then the <code>path</code> will always be set to the given value, even if no such key existed before. The default behaviour (<code>false</code>) is to NOT create any new path/key.</li><li><code>style</code> (string): an optional style to apply to the new value: <code>double</code> (add double quotes), <code>single</code> (add single quotes), <code>literal</code>, <code>folded</code> or <code>flow</code> - see <a href=https://mikefarah.gitbook.io/yq/operators/style>yq style reference</a>.</li></ul><p>Note that Octopilot will keep the comments in the YAML files - because we&rsquo;re using the great <a href=https://github.com/go-yaml/yaml/tree/v3>go-yaml v3 lib</a>. <a href=https://mikefarah.gitbook.io/yq/usage/output-format#indent>Just that it might rewrite a bit your indentation</a>.</p></div></section><section id=yq><h1><a href=#yq>YQ</a></h1><div class=content><p>The YQ updater is based on the excellent <a href=https://github.com/mikefarah/yq>yq</a> application - and Go lib. It is much more powerful than the basic <a href=#yaml>YAML updater</a> - because it supports all the <a href=https://mikefarah.gitbook.io/yq/operators>yq operators</a>, and because you are not limited to setting a value for a specific key. Also note that this updater can work on JSON files.</p><p>The syntax is: <code>yq(params)</code>, such as:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;yq(file=config.yaml,expression=&#39;.path.to.version = strenv(VERSION)&#39;)&#34; \
    ...
</code></pre></div><p>It support the following parameters:</p><ul><li><code>file</code> (string): mandatory path to the YAML (or JSON) file to update. Can be a file pattern - such as <code>config/*.yaml</code>. If it&rsquo;s a relative path, it will be relative to the root of the cloned git repository.</li><li><code>expression</code> (string): mandatory <a href=https://mikefarah.gitbook.io/yq/commands/evaluate>yq v4 expression</a> that will be evaluated against each file.</li><li><code>output</code> (string): optional output of the result. By default the result is written to the source file - in-place editing. But you can send the result to <code>stdout</code>, <code>stderr</code> or a specific file.</li><li><code>json</code> (boolean): if <code>true</code>, then the output will be written in JSON format instead of YAML format.</li><li><code>indent</code> (int): optional number of spaces used for indentation when writing the YAML file(s) after update. See <a href=https://mikefarah.gitbook.io/yq/usage/output-format#indent>yq doc on indent</a>. Default to <code>2</code>.</li><li><code>trim</code> (boolean): if <code>true</code>, the content will be &ldquo;trimmed&rdquo; before being written to disk - to avoid extra line break at the end of the file for example.</li><li><code>unwrapscalar</code> (boolean): if <code>true</code> (the default), only the value will be printed - not the comments. See <a href=https://mikefarah.gitbook.io/yq/usage/output-format#unwrap-scalars>yq doc on unwrap scalars</a>.</li></ul><p>Note that Octopilot will keep the comments in the YAML files - because we&rsquo;re using the great <a href=https://github.com/go-yaml/yaml/tree/v3>go-yaml v3 lib</a>. <a href=https://mikefarah.gitbook.io/yq/usage/output-format#indent>Just that it might rewrite a bit your indentation</a>.</p></div></section><section id=helm><h1><a href=#helm>Helm</a></h1><div class=content><p>The Helm updater is made to easily update the dependencies of one or more <a href=https://helm.sh/>Helm</a> charts. It supports both:</p><ul><li>Helm v3, with the dependencies declared in the <code>Chart.yaml</code> file</li><li>Helm v2, with the dependencies declared in the <code>requirements.yaml</code> file</li></ul><p>If you run the following command:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;helm(dependency=chart-name)=1.2.3&#34; \
    ...
</code></pre></div><p>Octopilot will discover all charts stored in the clone repository, and for each, try to change the version of the <code>chart-name</code> dependency to <code>1.2.3</code>.</p><p>The syntax is: <code>helm(params)=value</code> - you can read more about the value in the <a href=#value>&ldquo;value&rdquo; section</a>.</p><p>It support the following parameters:</p><ul><li><code>dependency</code> (string): mandatory name of the dependency to update. Must exists in the dependencies list - it won&rsquo;t be added.</li><li><code>indent</code> (int): optional number of spaces used for indentation when writing the YAML file(s) after update. Default to <code>2</code>.</li></ul><p>Note that Octopilot will keep the comments in the YAML files - because we&rsquo;re using the great <a href=https://github.com/go-yaml/yaml/tree/v3>go-yaml v3 lib</a>. <a href=https://mikefarah.gitbook.io/yq/usage/output-format#indent>Just that it might rewrite a bit your indentation</a>.</p></div></section><section id=sops><h1><a href=#sops>Sops</a></h1><div class=content><p>The <strong>sops</strong> updater can manipulate files encrypted with <a href=https://github.com/mozilla/sops>mozilla&rsquo;s sops</a> natively, without the need to install <a href=https://github.com/mozilla/sops>sops</a>. This is great if you want to store sensitive data in your git repositories: you can encrypt them with <code>sops</code>, and use Octopilot to update them automatically.</p><p>For example if you want to store your TLS certificate as a base64 encoded string in a sops-encrypted file:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update `sops(file=secrets.yaml,key=app.tls.base64encodedCertificateKey)=$(kubectl -n cert-manager get secrets tls-myapp -o template=&#39;{{index .data &#34;tls.key&#34;}}&#39;)` \
    ...
</code></pre></div><p>Given the following (decrypted) <code>secrets.yaml</code> file:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>app:
  tls:
    base64encodedCertificateKey: LS0tLS1CRUdJTiBSU0EgU...
</code></pre></div><p>Octopilot will decrypt the <code>secrets.yaml</code> file, set the value of the <code>app.tls.base64encodedCertificateKey</code> key to the given value, and re-encrypt the <code>secrets.yaml</code> file before writing it to disk.</p><p>The syntax is: <code>sops(params)=value</code> - you can read more about the value in the <a href=#value>&ldquo;value&rdquo; section</a>.</p><p>It support the following parameters:</p><ul><li><code>file</code> (string): mandatory path to the sops-encrypted file to update. Can be a file pattern - such as <code>config/secrets.*</code>. If it&rsquo;s a relative path, it will be relative to the root of the cloned git repository.</li><li><code>key</code> (string): mandatory key to update in the file(s).</li></ul><p>Note that depending on the sops backend you use (KMS, age, vault, &mldr;) you might need to set some environment variables, such as:</p><ul><li>for GCP KMS, the <code>GOOGLE_APPLICATION_CREDENTIALS</code> env var</li><li>for <a href=https://age-encryption.org/>age</a>, the <code>SOPS_AGE_KEY_FILE</code> env var</li><li>&mldr;</li></ul></div></section><section id=regex><h1><a href=#regex>Regex</a></h1><div class=content><p>The <strong>regex</strong> updater can be used to update any kind of text file using a regular expression - with the <a href=https://golang.org/pkg/regexp/syntax/>Golang syntax</a>, such as:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;regex(file=some-file.txt,pattern=&#39;version: \&#34;(.*)\&#34;&#39;)=${VERSION}&#34; \
    ...
</code></pre></div><p>Given the following <code>some-file.txt</code> file:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>version: &#34;1.0.0&#34;
...
</code></pre></div><p>Octopilot will replace the first line with <code>version: "1.2.3"</code> if the <code>$VERSION</code> env var is set to <code>1.2.3</code> for example.</p><p>The syntax is: <code>regex(params)=value</code> - you can read more about the value in the <a href=#value>&ldquo;value&rdquo; section</a>.</p><p>It support the following parameters:</p><ul><li><code>file</code> (string): mandatory path to the file to update. Can be a file pattern - such as <code>files/**/*.txt</code>. If it&rsquo;s a relative path, it will be relative to the root of the cloned git repository.</li><li><code>pattern</code> (string): mandatory regex pattern to find and replace something in the file(s). The pattern must be in the <a href=https://golang.org/pkg/regexp/syntax/>Golang syntax</a>. If this pattern includes a capturing group, then it will be replaced by the provided value.</li></ul><p>A few things you can do with the regex updater:</p><ul><li>replace the whole content of a file<div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;regex(file=my-file,pattern=&#39;(?ms)(.*)&#39;)=new content&#34; 
</code></pre></div></li></ul></div></section><section id=exec><h1><a href=#exec>Exec</a></h1><div class=content><p>The <strong>exec</strong> updater can execute any command you want, so you can change files in the cloned git repository with any tool you have available.</p><p>For example to update all your Go dependencies to the latest patch version:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;exec(cmd=go,args=get -u=patch)&#34; \
    --update &#34;exec(cmd=go,args=mod tidy)&#34; \
    --update &#34;exec(cmd=go,args=mod vendor)&#34; \
    ...
</code></pre></div><p>This will execute 3 commands, that will update the <code>go.mod</code> & <code>go.sum</code> files, and the <code>vendor</code> dir. Octopilot will then add/commit all the changes.</p><p>The syntax is: <code>exec(params)</code>.</p><p>It support the following parameters:</p><ul><li><code>cmd</code> (string): mandatory command to execute.</li><li><code>args</code> (string): optional arguments for the command. The arguments are space-separated. If you have a space in an argument, you can quote it, such as: <code>-c 'some arg' -x another</code>.</li><li><code>stdout</code> (string): optional path to a file where the std output of the command will be written. If it&rsquo;s a relative path, it will be relative to the root of the cloned git repository.</li><li><code>stderr</code> (string): optional path to a file where the std error output of the command will be written. If it&rsquo;s a relative path, it will be relative to the root of the cloned git repository.</li><li><code>timeout</code> (string/duration): optional maximum duration to wait for the command to finish, using the <a href=https://golang.org/pkg/time/#ParseDuration>Golang syntax</a>.</li></ul><p>A few things you can do with the regex updater:</p><ul><li>use a bash command to enable shell expansion (disabled by default when invoking commands through Octopilot)<div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;exec(cmd=sh,args=-c &#39;cat files/*.txt&#39;,stdout=output.txt)&#34;
</code></pre></div></li></ul></div></section><section id=value><h1><a href=#value>Value</a></h1><div class=content><p>Some updaters accept a <strong>value</strong> in their syntax, such as <code>updater(params)=value</code>.</p><p>This value can be either:</p><ul><li>a raw value</li><li>the content of a file</li></ul><h2 id=raw-value>Raw value</h2><p>This is the easiest way to set a value: just use a raw value, such as:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;yaml(file=config.yaml,path=&#39;version&#39;)=v1.2.3&#34; \
    ...
</code></pre></div><p>Note that you can also use an environment variable:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ export VERSION=v1.2.3
$ octopilot \
    --update &#34;yaml(file=config.yaml,path=&#39;version&#39;)=${VERSION}&#34; \
    ...
</code></pre></div><p>or any command you want:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ echo v1.2.3 &gt; /tmp/VERSION
$ octopilot \
    --update &#34;yaml(file=config.yaml,path=&#39;version&#39;)=$(cat /tmp/VERSION)&#34; \
    ...
</code></pre></div><h2 id=file-content>File content</h2><p>If you want to use the content of a file, you can use the <strong>file</strong> valuer:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ octopilot \
    --update &#34;yaml(file=config.yaml,path=&#39;version&#39;)=file(path=VERSION)&#34; \
    ...
</code></pre></div><p>It will read the <code>VERSION</code> file located at the root of the cloned git repository, and use its content as the value.</p><p>The syntax is: <code>file(params)</code>.</p><p>It support the following parameters:</p><ul><li><code>path</code> (string): mandatory path to the file to read. If it&rsquo;s a relative path, it will be relative to the root of the cloned git repository.</li></ul></div></section><section id=github><h1><a href=#github>GitHub</a></h1><div class=content></div></section><section id=auth><h1><a href=#auth>Auth</a></h1><div class=content></div></section><section id=advanced><h1><a href=#advanced>Advanced</a></h1><div class=content></div></section><section id=templating><h1><a href=#templating>Templating</a></h1><div class=content></div></section><section id=use-cases><h1><a href=#use-cases>Use cases</a></h1><div class=content></div></section><section id=faq><h1><a href=#faq>FAQ</a></h1><div class=content><ul><li>files path: relative or absolute</li></ul></div></section></div></div></div></div></div></div><div class=sub-footer><div class=container><div class=row><div class=col-12><div class=sub-footer-inner><ul><li><a href=https://www.dailymotion.com>Dailymotion</a></li></ul></div></div></div></div></div><script type=text/javascript src=js/scripts.min.eaf147370baecdd07c022597db631f99cab1c9cd6479de586f30327a568d6a0f.js></script></body></html>